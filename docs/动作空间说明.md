# 动作空间说明

## 简化后的动作空间设计

### 概述

为了简化训练并提高效率，我们将动作空间从复杂的多动作 `Dict` 空间简化为单一的**连续 Box 空间**。

### 动作空间定义

```python
# 动态计算坐标范围（基于size）
map_min = -size / 2.0
map_max = size / 2.0

gym.spaces.Box(
    low=np.array([0.0, map_min, map_min, 0.0], dtype=np.float32),
    high=np.array([1.0, map_max, map_max, 1.0], dtype=np.float32),
    dtype=np.float32
)

# 例如：size=40 时，坐标范围是 [-20, 20]
# 例如：size=100 时，坐标范围是 [-50, 50]
```

**4个连续值组成的向量：**
- `action[0]`: **动作类型** (0.0-1.0)
  - `< 0.5`: 投资 (invest)
  - `>= 0.5`: 创建新公司 (create)
  
- `action[1]`: **x坐标** (范围：-size/2 到 +size/2)
  - 投资时：寻找离该位置最近的指定tier公司进行投资
  - 创建时：在该位置创建新公司
  - 坐标以原点为中心，例如size=40时，范围是[-20, 20]
  
- `action[2]`: **y坐标** (范围：-size/2 到 +size/2)
  - 同x坐标

- `action[3]`: **tier/行业** (0.0-1.0，归一化值)
  - 映射到 [0,7] → 向上取整 → 1-7 → sector_id 0-6
  - 投资时：只投资指定tier（sector）的公司
  - 创建时：创建指定tier（sector）的公司

**金额说明：**
- **投资金额**：固定值，由配置项 `fixed_investment_amount` 决定（默认50,000）
- **创建资本**：在 `[new_company_capital_min, new_company_capital_max]` 范围内随机选择

**坐标系统：**
- 地图以原点(0,0)为中心
- size是地图边长，坐标范围是 **±size/2**
- 例如：size=40 → 坐标范围[-20, 20]，size=100 → 坐标范围[-50, 50]

### 动作执行逻辑

#### 投资动作 (action[0] < 0.5)

1. 使用固定投资金额 `fixed_investment_amount`（配置项）
2. 根据 `action[3]` 确定目标tier（sector_id）
3. 根据坐标 `(action[1], action[2])` 找到最近的**指定tier**的公司
4. 向该公司投资固定金额
5. 如果没有匹配tier的公司，返回 `invalid_no_matching_tier` 错误
6. 如果没有任何公司，返回 `invalid_no_firms` 错误

#### 创建动作 (action[0] >= 0.5)

1. 在配置范围 `[new_company_capital_min, new_company_capital_max]` 内随机选择初始资本
2. 根据 `action[3]` 确定要创建的行业 (sector)
3. 在坐标 `(action[1], action[2])` 创建指定行业的新公司
4. 如果公司数量已达上限，返回 `invalid_capacity` 错误

### 关键特性

1. **每步一个动作**：简化了多动作系统，每次只执行一个操作
2. **连续空间**：使用 Box 空间，完全兼容 Stable-Baselines3 的 PPO、A2C 等算法
3. **空间高效**：4维连续空间，极简设计
4. **位置感知**：通过坐标选择投资目标或创建位置，引入空间策略
5. **行业控制**：通过tier维度精确控制投资和创建的行业类型
6. **固定投资**：投资金额固定，简化决策空间，便于学习稳定的投资策略

### 配置参数

在 `config.json` 中的相关参数：

```json
{
  "environment": {
    "company": {
      "fixed_investment_amount": 50000.0,
      "new_company_capital_min": 1000.0,
      "new_company_capital_max": 1000000.0
    }
  }
}
```

- `fixed_investment_amount`: 固定投资金额（默认：50,000）
- `new_company_capital_min/max`: 创建公司的初始资本范围
- `size`: 地图边长（默认：40.0），决定坐标范围为 **±size/2**

**地图坐标系统：**
- 地图以原点为中心，坐标范围动态计算
- size=40 → 坐标[-20, 20]
- size=100 → 坐标[-50, 50]

### 奖励机制

- **成功投资**：`investment_amount × investment_multiplier`
- **成功创建**：`creation_reward`
- **无效动作**：`invalid_action_penalty` 或 `invalid_firm_penalty`
- **利润奖励**：`total_profit × profit_multiplier`

### 使用示例

```python
import numpy as np
from env import IndustryEnv
from config import Config

# 创建环境
config = Config()
env = IndustryEnv(config.environment)
obs, _ = env.reset(options={'initial_firms': 50})

# 投资动作：投资固定金额到中心附近的Raw材料公司(tier=0.1对应sector 0)
invest_action = np.array([0.2, 0.0, 0.0, 0.1], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(invest_action)

# 创建动作：在(-10, 5)位置创建OEM公司(tier=0.6对应sector 4)
# 初始资本会在配置范围内随机选择
create_action = np.array([0.8, -10.0, 5.0, 0.6], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(create_action)

# 创建Service公司：tier=0.8对应sector 5
service_create = np.array([0.9, 5.0, -5.0, 0.8], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(service_create)

# 随机动作
random_action = env.action_space.sample()
obs, reward, terminated, truncated, info = env.step(random_action)
```

### 训练示例

```bash
# 使用 PPO 训练
uv run python main.py --framework sb3 --algorithm ppo --timesteps 100000

# 使用 A2C 训练
uv run python main.py --framework sb3 --algorithm a2c --timesteps 100000
```

### 与旧版本的差异

| 特性 | 旧版本 | 当前版本 |
|------|--------|--------|
| 动作空间类型 | Dict (嵌套) | Box (连续) |
| 动作维度 | 多个嵌套字段 | **4维连续向量** |
| 每步动作数 | 0-10个 | 固定1个 |
| 投资金额 | 可变范围 | **固定金额** |
| 创建资本 | 可选范围 | 随机（配置范围内） |
| 位置选择 | 连续 (创建) / 索引 (投资) | 连续坐标统一 |
| 行业选择 | 手动指定或随机 | 连续tier维度控制 |
| SB3兼容性 | 需要自定义 | 原生支持 |

### 优势

1. **简单性**：单一Box空间，易于理解和训练
2. **兼容性**：与所有标准RL算法兼容
3. **灵活性**：连续空间允许精确控制金额和位置
4. **效率**：减少了动作空间的复杂度

### 未来改进方向

1. ✅ ~~允许智能体选择行业类型（增加第5维）~~ **已实现**
2. 支持同时投资多家公司（增加批次维度）
3. 添加特殊动作（如关闭公司、合并等）
4. 引入宏观经济参数控制
5. 添加多步动作序列支持

