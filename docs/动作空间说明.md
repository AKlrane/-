# 动作空间说明

## 简化后的动作空间设计

### 概述

为了简化训练并提高效率，我们将动作空间从复杂的多动作 `Dict` 空间简化为单一的**连续 Box 空间**。

### 动作空间定义

```python
gym.spaces.Box(
    low=np.array([0.0, 0.0, -20.0, -20.0], dtype=np.float32),
    high=np.array([1.0, 1.0, 20.0, 20.0], dtype=np.float32),
    dtype=np.float32
)
```

**4个连续值组成的向量：**
- `action[0]`: **动作类型** (0.0-1.0)
  - `< 0.5`: 投资 (invest)
  - `>= 0.5`: 创建新公司 (create)
  
- `action[1]`: **金额** (0.0-1.0，归一化值)
  - 投资时：映射到 `[investment_min, investment_max]`
  - 创建时：映射到 `[new_company_capital_min, new_company_capital_max]`
  
- `action[2]`: **x坐标** (-20.0 到 20.0 km)
  - 投资时：寻找离该位置最近的公司进行投资
  - 创建时：在该位置创建新公司
  
- `action[3]`: **y坐标** (-20.0 到 20.0 km)
  - 同x坐标

### 动作执行逻辑

#### 投资动作 (action[0] < 0.5)

1. 将归一化金额 `action[1]` 转换为实际投资金额
2. 根据坐标 `(action[2], action[3])` 找到最近的公司
3. 向该公司投资指定金额
4. 如果没有公司，返回 `invalid_no_firms` 错误

#### 创建动作 (action[0] >= 0.5)

1. 将归一化金额 `action[1]` 转换为初始资本
2. 随机选择一个行业 (sector)
3. 在坐标 `(action[2], action[3])` 创建新公司
4. 如果公司数量已达上限，返回 `invalid_capacity` 错误

### 关键特性

1. **每步一个动作**：简化了多动作系统，每次只执行一个操作
2. **连续空间**：使用 Box 空间，完全兼容 Stable-Baselines3 的 PPO、A2C 等算法
3. **空间高效**：4维连续空间，相比离散化更灵活
4. **位置感知**：通过坐标选择投资目标或创建位置，引入空间策略

### 配置参数

在 `config.json` 中的相关参数：

```json
{
  "environment": {
    "investment_min": 0.0,
    "investment_max": 1000000.0,
    "new_company_capital_min": 1000.0,
    "new_company_capital_max": 1000000.0
  }
}
```

地图范围硬编码为 **±20 km**，对应真实数据的坐标范围。

### 奖励机制

- **成功投资**：`investment_amount × investment_multiplier`
- **成功创建**：`creation_reward`
- **无效动作**：`invalid_action_penalty` 或 `invalid_firm_penalty`
- **利润奖励**：`total_profit × profit_multiplier`

### 使用示例

```python
import numpy as np
from env import IndustryEnv
from config import Config

# 创建环境
config = Config()
env = IndustryEnv(config.environment)
obs, _ = env.reset(options={'initial_firms': 50})

# 投资动作：投资50%金额到中心附近的公司
invest_action = np.array([0.2, 0.5, 0.0, 0.0], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(invest_action)

# 创建动作：用70%资本在(-10, 5)位置创建新公司
create_action = np.array([0.8, 0.7, -10.0, 5.0], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(create_action)

# 随机动作
random_action = env.action_space.sample()
obs, reward, terminated, truncated, info = env.step(random_action)
```

### 训练示例

```bash
# 使用 PPO 训练
uv run python main.py --framework sb3 --algorithm ppo --timesteps 100000

# 使用 A2C 训练
uv run python main.py --framework sb3 --algorithm a2c --timesteps 100000
```

### 与旧版本的差异

| 特性 | 旧版本 | 新版本 |
|------|--------|--------|
| 动作空间类型 | Dict (嵌套) | Box (连续) |
| 每步动作数 | 0-10个 | 固定1个 |
| 金额选择 | 离散档位 | 连续值 |
| 位置选择 | 连续 (创建) / 索引 (投资) | 连续坐标统一 |
| SB3兼容性 | 需要自定义 | 原生支持 |
| 行业选择 | 手动指定 | 自动随机 |

### 优势

1. **简单性**：单一Box空间，易于理解和训练
2. **兼容性**：与所有标准RL算法兼容
3. **灵活性**：连续空间允许精确控制金额和位置
4. **效率**：减少了动作空间的复杂度

### 未来改进方向

1. 允许智能体选择行业类型（增加第5维）
2. 支持同时投资多家公司（增加批次维度）
3. 添加特殊动作（如关闭公司、合并等）
4. 引入宏观经济参数控制

