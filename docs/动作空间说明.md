# 动作空间说明

## 基于 Logits 的动作空间设计（带 Tier 轮换）

### 概述

动作空间使用 **logits** 形式，通过 softmax 选择动作类型。**Tier（行业）由环境自动轮换决定**，模型接收当前 tier 信息作为输入，确保每个时间步操作不同的 tier，避免模型陷入重复操作同一 tier 的困境。

### 动作空间定义

```python
gym.spaces.Box(
    low=np.array([-10.0, -10.0, -1.0, -1.0], dtype=np.float32),
    high=np.array([10.0, 10.0, 1.0, 1.0], dtype=np.float32),
    dtype=np.float32
)
```

**4个连续值组成的向量：**
- `action[0]`: **logits_invest** (logit，范围 [-10, 10]，用于投资动作)
- `action[1]`: **logits_create** (logit，范围 [-10, 10]，用于创建动作)
  - 对 `[logits_invest, logits_create]` 应用 softmax，取 argmax 决定动作类型
  - argmax = 0 → 投资 (invest)
  - argmax = 1 → 创建 (create)
  
- `action[2]`: **x坐标** (归一化到 [-1, 1])
  - 投资时：寻找离该位置最近的指定tier公司进行投资
  - 创建时：在该位置创建新公司
  - 坐标归一化到 [-1, 1]，环境内部会按比例放缩到实际地图大小
  - 例如：size=40时，-1对应-20，0对应0，1对应+20
  
- `action[3]`: **y坐标** (归一化到 [-1, 1])
  - 同x坐标，归一化到 [-1, 1]

### Tier 轮换机制

**Tier 由环境自动轮换，模型不需要输出 tier 信息：**
- 环境按照 0-5 的顺序，在每个时间步轮流操作不同的 tier
- 当前 tier 信息（0-5）会作为观察的一部分提供给模型
- 在观察空间中，tier 信息作为额外的通道添加到 grid map 中（第8个通道）
- 每执行一步后，环境自动将 `current_tier_index` 递增，循环 0→1→2→3→4→5→0...
- **注意**：只支持 sector 0-5（不包括 Other/sector 6）

**金额说明：**
- **投资金额**：固定值，由配置项 `fixed_investment_amount` 决定（默认50,000）
- **创建资本**：在 `[new_company_capital_min, new_company_capital_max]` 范围内随机选择

**坐标系统：**
- 地图以原点(0,0)为中心
- Agent输出的坐标归一化到 **[-1, 1]** 范围，便于模型学习
- 环境内部会将归一化坐标按比例放缩到实际地图大小
- 实际地图坐标范围是 **±size/2**
- 例如：size=40 → 实际坐标范围[-20, 20]，但agent输出范围是[-1, 1]
- 例如：size=100 → 实际坐标范围[-50, 50]，但agent输出范围是[-1, 1]

### 动作执行逻辑

#### 动作类型选择

1. 对 `[logits_invest, logits_create]` 应用 softmax，得到概率分布
2. 取 argmax 决定动作类型：
   - argmax = 0 → 投资 (invest)
   - argmax = 1 → 创建 (create)

#### 行业类型选择（环境自动决定）

1. 环境使用 `current_tier_index`（0-5）作为目标 sector_id
2. 每执行一步后，环境自动将 `current_tier_index` 递增：`(current_tier_index + 1) % 6`
3. 这样确保每个时间步操作不同的 tier，循环 0→1→2→3→4→5→0...

#### 投资动作

1. 使用固定投资金额 `fixed_investment_amount`（配置项）
2. 使用环境维护的 `current_tier_index` (0-5) 作为目标 sector_id
3. 根据坐标 `(action[2], action[3])` 找到最近的**指定tier**的公司
4. 向该公司投资固定金额
5. 如果没有匹配tier的公司，返回 `invalid_no_matching_tier` 错误
6. 如果没有任何公司，返回 `invalid_no_firms` 错误

#### 创建动作

1. 在配置范围 `[new_company_capital_min, new_company_capital_max]` 内随机选择初始资本
2. 使用环境维护的 `current_tier_index` (0-5) 作为目标 sector_id
3. 在坐标 `(action[2], action[3])` 创建指定行业的新公司
4. 如果公司数量已达上限，返回 `invalid_capacity` 错误

### 关键特性

1. **每步一个动作**：简化了多动作系统，每次只执行一个操作
2. **Logits 设计**：使用 logits + softmax 选择动作类型，使模型输出更一致
3. **Tier 轮换机制**：环境自动轮换 tier (0-5)，确保每个时间步操作不同的行业，避免模型陷入重复操作
4. **连续空间**：使用 Box 空间，完全兼容 Stable-Baselines3 的 PPO、A2C 等算法
5. **空间高效**：4维连续空间（2个 logits + 2个坐标）
6. **位置感知**：通过坐标选择投资目标或创建位置，引入空间策略
7. **行业信息输入**：当前 tier 信息作为观察的一部分（grid map 的第8个通道），模型可以据此调整策略
8. **固定投资**：投资金额固定，简化决策空间，便于学习稳定的投资策略
9. **无越界惩罚**：移除了 action_type 和 tier 的越界惩罚，只保留坐标越界惩罚

### 配置参数

在 `config.json` 中的相关参数：

```json
{
  "environment": {
    "company": {
      "fixed_investment_amount": 50000.0,
      "new_company_capital_min": 1000.0,
      "new_company_capital_max": 1000000.0
    }
  }
}
```

- `fixed_investment_amount`: 固定投资金额（默认：50,000）
- `new_company_capital_min/max`: 创建公司的初始资本范围
- `size`: 地图边长（默认：40.0），决定坐标范围为 **±size/2**

**地图坐标系统：**
- 地图以原点为中心，坐标范围动态计算
- size=40 → 坐标[-20, 20]
- size=100 → 坐标[-50, 50]

### 奖励机制

- **成功投资**：`investment_amount × investment_multiplier`
- **成功创建**：`creation_reward`
- **无效动作**：`invalid_action_penalty` 或 `invalid_firm_penalty`
- **利润奖励**：`total_profit × profit_multiplier`
- **坐标越界惩罚**：`invalid_coordinate_penalty`（仅坐标有越界检查）
- **注意**：不再有 action_type 和 tier 的越界惩罚

### 使用示例

```python
import numpy as np
from env import IndustryEnv
from config import Config

# 创建环境
config = Config()
env = IndustryEnv(config.environment)
obs, _ = env.reset(options={'initial_firms': 50})

# 投资动作：投资固定金额到中心附近
# 使用 logits: 高 invest logit，低 create logit
# Tier 由环境自动决定（当前 current_tier_index）
# 坐标归一化到[-1, 1]，(0.0, 0.0)对应地图中心
invest_action = np.array([
    5.0,   # logits_invest (高值，选择投资)
    -5.0,  # logits_create (低值)
    0.0,   # x coordinate
    0.0    # y coordinate
], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(invest_action)

# 创建动作：在归一化坐标(-0.5, 0.25)位置创建公司
# 使用 logits: 低 invest logit，高 create logit
# Tier 由环境自动决定（当前 current_tier_index）
create_action = np.array([
    -5.0,  # logits_invest (低值)
    5.0,   # logits_create (高值，选择创建)
    -0.5,  # x coordinate
    0.25   # y coordinate
], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(create_action)

# 随机动作（使用正态分布生成 logits）
random_action = np.array([
    np.random.normal(0, 1),  # logits_invest
    np.random.normal(0, 1),  # logits_create
    np.random.uniform(-1, 1),  # x coordinate
    np.random.uniform(-1, 1)   # y coordinate
], dtype=np.float32)
obs, reward, terminated, truncated, info = env.step(random_action)
```

### 训练示例

```bash
# 使用 PPO 训练
uv run python main.py --framework sb3 --algorithm ppo --timesteps 100000

# 使用 A2C 训练
uv run python main.py --framework sb3 --algorithm a2c --timesteps 100000
```

### 与旧版本的差异

| 特性 | 旧版本 | 当前版本 |
|------|--------|--------|
| 动作空间类型 | Dict (嵌套) | Box (连续) |
| 动作维度 | 多个嵌套字段 | **4维连续向量** (2 logits + 2坐标) |
| 每步动作数 | 0-10个 | 固定1个 |
| 投资金额 | 可变范围 | **固定金额** |
| 创建资本 | 可选范围 | 随机（配置范围内） |
| 位置选择 | 连续 (创建) / 索引 (投资) | 连续坐标统一 |
| 行业选择 | 手动指定或随机 | **环境自动轮换** (0-5循环) |
| 动作类型选择 | 手动指定 | Logits + softmax 选择 |
| Tier 信息输入 | 无 | 作为观察的一部分（grid map 第8通道） |
| 越界惩罚 | 所有维度 | 仅坐标维度 |
| SB3兼容性 | 需要自定义 | 原生支持 |

### 优势

1. **简单性**：单一Box空间，易于理解和训练
2. **兼容性**：与所有标准RL算法兼容
3. **灵活性**：连续空间允许精确控制金额和位置
4. **效率**：减少了动作空间的复杂度

### 未来改进方向

1. ✅ ~~允许智能体选择行业类型（增加第5维）~~ **已实现**
2. 支持同时投资多家公司（增加批次维度）
3. 添加特殊动作（如关闭公司、合并等）
4. 引入宏观经济参数控制
5. 添加多步动作序列支持

